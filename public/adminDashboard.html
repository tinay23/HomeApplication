<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta http-equiv="Cache-Control" content="no-store">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
    }
    
    .hidden {
    	display: none !important;
    }

    .dashboard-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 20px;
    }

    .report-card {
        background: #fafafa;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .btn {
        padding: 8px 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        margin-right: 6px;
        margin-top: 6px;
        font-weight: bold;
    }

    .btn-danger { background: #d9534f; color: white; }
    .btn-warning { background: #f0ad4e; color: white; }
    .btn-success { background: #5cb85c; color: white; }
    .btn-info { background: #0275d8; color: white; }

    .tab-btn {
      padding: 10px 18px;
      margin: 0 5px;
      border: none;
      background: #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-btn.active {
      background: #0275d8;
      color: white;
    }

</style>
</head>
<body>

<div class="dashboard-container">
    <h1>Admin Dashboard</h1>
<div style="text-align:center; margin-bottom:15px;">
    <button id="logoutBtn" class="btn btn-warning">Logout</button>
</div>
<!-- TAB BUTTONS -->
<div style="text-align:center; margin-bottom:20px;">
    <button id="tab-active" class="tab-btn active">Active Reports</button>
    <button id="tab-resolved" class="tab-btn">Resolved Reports</button>
</div>

<!-- TAB CONTENT -->
<div id="activeReports"></div>
<div id="resolvedReports" class="hidden"></div>


<div id="chatModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center;">

    <div style="background:white; width:420px; max-height:80%; overflow-y:auto; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3);">

        <h2>Job Chat History</h2>
        <div id="chatModalMessages" style="background:#f2f2f2; padding:10px; border-radius:6px; height:350px; overflow-y:auto;">
        </div>

        <button onclick="closeChatModal()" style="margin-top:10px; padding:10px 20px; background:#0077cc; color:white; border:none; border-radius:5px;">
            Close
        </button>
    </div>
</div>

</div>

<script>
// Prevent Back button from showing cached admin page
window.addEventListener("pageshow", (event) => {
    if (event.persisted) {
        window.location.reload();
    }
});

// Block access if not logged in
if (!localStorage.getItem("user_id")) {
    window.location.replace("/login.html");
}

// Load reports when page opens
document.addEventListener("DOMContentLoaded", () => {
    loadActiveReports();
    setupTabs();
});

async function loadReports() {
    const res = await fetch("/admin_get_reports");
    const data = await res.json();

    const container = document.getElementById("reportList");
    container.innerHTML = "";

    if (!data.ok || data.reports.length === 0) {
        container.innerHTML = "<p>No reports found.</p>";
        return;
    }

    data.reports.forEach(r => {
        container.innerHTML += `
            <div class="report-card">
                <h3>Report #${r.report_id}</h3>
                <p><strong>Reporter:</strong> ${r.reporter_name}</p>
                <p><strong>Target Type:</strong> ${r.target_type}</p>
                <p><strong>Target ID:</strong> ${r.target_id}</p>
                <p><strong>Reason:</strong> ${r.reason}</p>
                <p><strong>Status:</strong> ${r.status}</p>

                <div>
                    <button class="btn btn-success" onclick="resolveReport(${r.report_id})">
                        Mark Resolved
                    </button>

                    ${r.target_type === 'review' ? `
                        <button class="btn btn-danger" onclick="deleteReview(${r.target_id}, ${r.report_id})">
                            Delete Review
                        </button>
                    ` : ""}

		    ${r.target_type === 'job' ? `
		        <button class="btn btn-info" onclick="viewChat(${r.target_id})">
        		    View Chat
    			</button>
    			<button class="btn btn-danger" onclick="deleteJob(${r.target_id}, ${r.report_id})">
        		Delete Job
    			</button>
		    ` : ""}

                    ${(r.target_type === 'homeowner' || r.target_type === 'contractor') ? `
			<button class="btn btn-info" onclick="viewUserChat(${r.target_id}, '${r.target_type}')">
        		View Chat
    			</button>
                        <button class="btn btn-warning" onclick="banUser(${r.target_id}, ${r.report_id})">
                            Ban User
                        </button>
                    ` : ""}
                </div>
            </div>
        `;
    });
}

async function viewUserChat(user_id, user_type) {

    const res = await fetch(`/admin_get_user_chat?user_id=${user_id}&user_type=${user_type}`);
    const data = await res.json();

    const box = document.getElementById("chatModalMessages");
    box.innerHTML = "";

    if (!data.ok || data.jobs.length === 0) {
        box.innerHTML = "<p>No chat history found for this user.</p>";
    } else {
        data.jobs.forEach(job => {
            const header = document.createElement("h3");
            header.textContent = `Job #${job.job_id}`;
            box.appendChild(header);

            if (job.messages.length === 0) {
                box.innerHTML += "<p>No chat messages for this job.</p>";
                return;
            }

            job.messages.forEach(m => {
                const msgDiv = document.createElement("div");
                msgDiv.style.marginBottom = "8px";

                msgDiv.innerHTML = `
                    <strong>${m.sender_label}</strong>
                    <br>
                    <span>${m.message}</span>
                    <br>
                    <small style="color:#666">${new Date(m.sent_at).toLocaleString()}</small>
                    <hr>
                `;

                box.appendChild(msgDiv);
            });
        });
    }

    document.getElementById("chatModal").classList.remove("hidden");
}


async function resolveReport(report_id) {
    await fetch(`/admin_resolve_report?report_id=${report_id}`);

    // Reload depending on active tab
    if (document.getElementById("tab-active").classList.contains("active")) {
        loadActiveReports();
    } else {
        loadResolvedReports();
    }
}

async function deleteReview(review_id, report_id) {
    await fetch(`/admin_delete_review?review_id=${review_id}`);
    await resolveReport(report_id);
}

async function deleteJob(job_id, report_id) {
    await fetch(`/admin_delete_job?job_id=${job_id}`);
    await resolveReport(report_id);
}

async function banUser(user_id, report_id) {
    await fetch(`/admin_ban_user?user_id=${user_id}`);
    await resolveReport(report_id);
}

async function viewChat(job_id) {
    const res = await fetch(`/admin_get_chat?job_id=${job_id}`);
    const data = await res.json();

    const box = document.getElementById("chatModalMessages");
    box.innerHTML = "";

    if (!data.ok || data.messages.length === 0) {
        box.innerHTML = "<p>No chat messages found for this job.</p>";
    } else {
        data.messages.forEach(m => {
            const msgDiv = document.createElement("div");
            msgDiv.style.marginBottom = "8px";

            msgDiv.innerHTML = `
                <strong>${m.sender_label}</strong>
                <br>
                <span>${m.message}</span>
                <br>
                <small style="color:#666">${new Date(m.sent_at).toLocaleString()}</small>
                <hr>
            `;

            box.appendChild(msgDiv);
        });
    }

    document.getElementById("chatModal").classList.remove("hidden");
}

function closeChatModal() {
    document.getElementById("chatModal").classList.add("hidden");
}

function setupTabs() {
    const tabActive = document.getElementById("tab-active");
    const tabResolved = document.getElementById("tab-resolved");

    tabActive.addEventListener("click", () => {
        tabActive.classList.add("active");
        tabResolved.classList.remove("active");

        document.getElementById("activeReports").classList.remove("hidden");
        document.getElementById("resolvedReports").classList.add("hidden");

        loadActiveReports();
    });

    tabResolved.addEventListener("click", () => {
        tabResolved.classList.add("active");
        tabActive.classList.remove("active");

        document.getElementById("activeReports").classList.add("hidden");
        document.getElementById("resolvedReports").classList.remove("hidden");

        loadResolvedReports();
    });
}

// Load unresolved reports
async function loadActiveReports() {
    const res = await fetch("/admin_get_reports");
    const data = await res.json();

    const container = document.getElementById("activeReports");
    container.innerHTML = "";

    if (!data.ok || data.reports.length === 0) {
        container.innerHTML = "<p>No active reports.</p>";
        return;
    }

    data.reports
        .filter(r => r.status !== "resolved")
        .forEach(r => container.innerHTML += generateReportCard(r));
}

// Load resolved reports
async function loadResolvedReports() {
    const res = await fetch("/admin_get_reports");
    const data = await res.json();

    const container = document.getElementById("resolvedReports");
    container.innerHTML = "";

    if (!data.ok) {
        container.innerHTML = "<p>Error loading reports.</p>";
        return;
    }

    const resolved = data.reports.filter(r => r.status === "resolved");

    if (resolved.length === 0) {
        container.innerHTML = "<p>No resolved reports.</p>";
        return;
    }

    resolved.forEach(r => container.innerHTML += generateResolvedReportCard(r));
}

function generateReportCard(r) {
    return `
        <div class="report-card">
            <h3>Report #${r.report_id}</h3>
            <p><strong>Reporter:</strong> ${r.reporter_name}</p>
            <p><strong>Target Type:</strong> ${r.target_type}</p>
            <p><strong>Target ID:</strong> ${r.target_id}</p>
            <p><strong>Reason:</strong> ${r.reason}</p>
            <p><strong>Status:</strong> ${r.status}</p>

            <div>
                <button class="btn btn-success" onclick="resolveReport(${r.report_id})">
                    Mark Resolved
                </button>

                ${r.target_type === 'review' ? `
                    <button class="btn btn-danger" onclick="deleteReview(${r.target_id}, ${r.report_id})">
                        Delete Review
                    </button>
                ` : ""}

                ${r.target_type === 'job' ? `
                    <button class="btn btn-info" onclick="viewChat(${r.target_id})">
                        View Chat
                    </button>
                    <button class="btn btn-danger" onclick="deleteJob(${r.target_id}, ${r.report_id})">
                        Delete Job
                    </button>
                ` : ""}

                ${(r.target_type === 'homeowner' || r.target_type === 'contractor') ? `
		    <button class="btn btn-info" onclick="viewUserChat(${r.target_id}, '${r.target_type}')">
        		View Chat
    		    </button>
                    <button class="btn btn-warning" onclick="banUser(${r.target_id}, ${r.report_id})">
                        Ban User
                    </button>
                ` : ""}
            </div>
        </div>
    `;
}

function generateResolvedReportCard(r) {
    return `
        <div class="report-card">
            <h3>Report #${r.report_id} (Resolved)</h3>
            <p><strong>Reporter:</strong> ${r.reporter_name}</p>
            <p><strong>Target Type:</strong> ${r.target_type}</p>
            <p><strong>Target ID:</strong> ${r.target_id}</p>
            <p><strong>Reason:</strong> ${r.reason}</p>
            <p><strong>Status:</strong> <span style="color:green;">Resolved</span></p>
        </div>
    `;
}


document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user_id");
    localStorage.removeItem("role");
    localStorage.removeItem("full_name");

    window.location.href = "/login.html";
});

</script>

</body>
</html>
